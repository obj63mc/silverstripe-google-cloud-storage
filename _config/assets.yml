---
Name: silverstripegooglecloudstorage-flysystem
Only:
  envvarset:
    - GC_BUCKET_NAME
    - GC_KEY_FILE
After:
  - '#assetsflysystem'
---
SilverStripe\Core\Injector\Injector:
  SilverStripe\GoogleCloudStorage\Adapter\BucketAdapter:
    constructor:
      bucket: '`GC_BUCKET_NAME`'
      keyFile: '`GC_KEY_FILE`'

  League\Flysystem\Adapter\Local:
    class: League\Flysystem\Adapter\Local
    constructor:
      root: '`TEMP_PATH`'

  SilverStripe\GoogleCloudStorage\Adapter\PublicAdapter:
    constructor:
      bucketAdapter: '%$SilverStripe\GoogleCloudStorage\Adapter\BucketAdapter'
      prefix: '`GC_PUBLIC_BUCKET_PREFIX`'
  Symfony\Component\Cache\Adapter\FilesystemAdapter.public:
    class: Symfony\Component\Cache\Adapter\FilesystemAdapter
    constructor:
      namespace: 'flysystem-public'
      expire: 2592000
  SilverStripe\Assets\Flysystem\PublicAdapter:
    class: SilverStripe\GoogleCloudStorage\Adapter\PublicCachedAdapter
    constructor:
      adapter: '%$SilverStripe\GoogleCloudStorage\Adapter\PublicAdapter'
      cache: '%$Symfony\Component\Cache\Adapter\FilesystemAdapter.public'
  League\Flysystem\Filesystem.public:
    class: SilverStripe\Assets\Flysystem\Filesystem
    constructor:
      FilesystemAdapter: '%$SilverStripe\Assets\Flysystem\PublicAdapter'
      FilesystemConfig:
        visibility: public

  SilverStripe\GoogleCloudStorage\Adapter\ProtectedAdapter:
    constructor:
      bucketAdapter: '%$SilverStripe\GoogleCloudStorage\Adapter\BucketAdapter'
      prefix: '`GC_PROTECTED_BUCKET_PREFIX`'
  Symfony\Component\Cache\Adapter\FilesystemAdapter.protected:
    class: Symfony\Component\Cache\Adapter\FilesystemAdapter
    constructor:
      namespace: 'flysystem-protected'
      expire: 2592000
  SilverStripe\Assets\Flysystem\ProtectedAdapter:
    class: SilverStripe\GoogleCloudStorage\Adapter\ProtectedCachedAdapter
    constructor:
      adapter: '%$SilverStripe\GoogleCloudStorage\Adapter\ProtectedAdapter'
      cache: '%$Symfony\Component\Cache\Adapter\FilesystemAdapter.protected'
  League\Flysystem\Filesystem.protected:
    class: SilverStripe\Assets\Flysystem\Filesystem
    constructor:
      FilesystemAdapter: '%$SilverStripe\Assets\Flysystem\ProtectedAdapter'
      FilesystemConfig:
        visibility: private
---
Name: silverstripegooglecloudstorage-assetscore
Only:
  envvarset: GC_BUCKET_NAME
After:
  - '#assetsflysystem'
  - '#assetscore'
---
SilverStripe\Core\Injector\Injector:
  # Define our SS asset backend
  SilverStripe\Assets\Storage\AssetStore:
    class: SilverStripe\Assets\Flysystem\FlysystemAssetStore
    properties:
      PublicFilesystem: '%$League\Flysystem\Filesystem.public'
      ProtectedFilesystem: '%$League\Flysystem\Filesystem.protected'
  SilverStripe\Assets\Storage\GeneratedAssetHandler:
    class: SilverStripe\Assets\Flysystem\GeneratedAssets
    properties:
      Filesystem: '%$League\Flysystem\Filesystem.public'
  SilverStripe\View\Requirements_Backend:
    properties:
      AssetHandler: '%$SilverStripe\Assets\Storage\GeneratedAssetHandler'
---
Name: silverstripegooglecloudstorage-errorpage
Only:
  envvarset: GC_BUCKET_NAME
After:
  - '#errorpage-extensions'
---
SilverStripe\ErrorPage\ErrorPage:
  store_filepath: 'error-pages'

